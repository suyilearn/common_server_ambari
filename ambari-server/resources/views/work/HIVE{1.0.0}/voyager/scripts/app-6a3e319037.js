"use strict";angular.module("voyager",["vlui","zeroclipboard","720kb.tooltips","ngOrderObjectBy","ngCookies","ngTouch","ngSanitize","ui.router"]).constant("_",window._).constant("jQuery",window.$).constant("vl",window.vl).constant("vg",window.vg).constant("cp",window.cp).constant("tv4",window.tv4).constant("Papa",window.Papa).constant("Blob",window.Blob).constant("URL",window.URL).constant("Tether",window.Tether).constant("Drop",window.Drop).constant("dl",window.dl).config(["uiZeroclipConfigProvider",function(e){e.setZcConf({swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"})}]).config(["$stateProvider","$urlRouterProvider","consts",function(e,t,i){window.vl.extend(i,{debug:!0,debugInList:!0,numInitClusters:15,numMoreClusters:9,appId:"voyager",enableExclude:!0}),e.state("home",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl"}),t.otherwise("/")}]),angular.module("voyager").directive("visList",["Fields","Visrec","vl","jQuery","consts","_","Logger",function(e,t,i,s,l,n,a){return{templateUrl:"components/vislist/vislist.html",restrict:"E",replace:!0,scope:{},link:function(r,o){function d(){r.limit=l.numInitClusters,o.scrollTop(0);var i=e.update();t.update.projections(i)}r.Fields=e,r.Visrec=t,r.consts=l,r.shorthands=i.field.shorthands,r.limit=l.numInitClusters,r.rendering=!1,o.bind("scroll",function(){s(this).scrollTop()+s(this).innerHeight()>=s(this)[0].scrollHeight&&r.limit<t.fieldSets.length&&r.increaseLimit()}),r.increaseLimit=function(){r.limit+l.numMoreClusters>t.numClustersGenerated&&t.update.clusters(r.limit+l.numMoreClusters),r.limit+=l.numMoreClusters,a.logInteraction(a.actions.LOAD_MORE,r.limit)},r.select=function(e,i){a.logInteraction(a.actions.DRILL_DOWN_OPEN,e.key),t.selectedFieldSet=e,t.selectedCluster=i},r.isInList=function(e){return e in t.chartClusters};var c=n.debounce(d,200,{maxWait:1500});r.$watch("Fields.fields",function(e,t){t&&0!==n.keys(t).length?c():d()},!0)}}}]),angular.module("voyager").directive("functionList",["_","vl","Logger",function(e,t,i){return{templateUrl:"components/functionlist/functionlist.html",restrict:"E",scope:{field:"="},link:function(e){function s(e){return"T"===e?t.schema.timeUnits:[]}function l(e){return t.schema.aggregate.supportedEnums[e]}var n="bin",a="raw",r="count",o="AUTO";e.func={selected:o,list:[o]},e.functionChanged=function(t){var r=e.field,d=r?r.type:"";r&&(r._bin=t===n||void 0,r._aggregate=-1!==l(d).indexOf(t)?t:void 0,r._timeUnit=-1!==s(d).indexOf(t)?t:void 0,r._raw=t===a||void 0,r._any=t===o||void 0,i.logInteraction(i.actions.FUNC_CHANGE,t))},e.$watch("field",function(i){if(i){var d=i.name?i.type:"";if(t.field.isCount(i))e.func.list=[r],e.func.selected=r;else{var c="O"===d;e.func.list=(c?[a]:[o,a]).concat(s(d)).concat(l(d).filter(function(e){return e!==r})).concat("Q"===d?[n]:[]),e.func.selected=i._bin?n:i._raw?a:i._aggregate||i._timeUnit||(c?a:o)}}},!0)}}}]),angular.module("voyager").directive("fieldListItem",["Dataset","Fields","consts",function(e,t,i){return{templateUrl:"components/fieldlistitem/fieldlistitem.html",restrict:"E",replace:!0,scope:{field:"="},link:function(e,s){e.consts=i,e.Fields=t,e.popupContent=s.find(".popup-functions")[0]},controller:["$scope","Dataset",function(e,t){e.stats=t.stats[e.field.name]}]}}]),angular.module("voyager").directive("fieldList",["Dataset","Fields",function(e,t){return{templateUrl:"components/fieldlist/fieldlist.html",restrict:"E",scope:{},link:function(i){i.Dataset=e,i.Fields=t}}}]),angular.module("voyager").directive("encodingVariations",["Visrec","consts","$document","_","Logger",function(e,t,i,s,l){return{templateUrl:"components/encodingvariations/encodingvariations.html",restrict:"E",replace:!0,scope:{},link:function(n){function a(e){27===e.keyCode&&(console.log("escape"),n.close(),angular.element(i).off("keydown",a))}n.Visrec=e,n.consts=t,n._=s,angular.element(i).on("keydown",a),n.isInList=function(t){return e.selectedCluster&&t===e.selectedCluster.key},n.select=function(e){n.selectedSubcluster=e,l.logInteraction(l.actions.CLUSTER_SELECT,e)},n.close=function(){l.logInteraction(l.actions.DRILL_DOWN_CLOSE,e.selectedCluster.key),n.Visrec.selectedCluster=null},n.$watch("Visrec.selectedCluster",function(e){n.selectedSubcluster=e?e[0]:null})}}}]),angular.module("voyager").directive("alertMessages",["Alerts",function(e){return{templateUrl:"components/alertmessages/alertmessages.html",restrict:"E",scope:{},link:function(t){t.Alerts=e}}}]),angular.module("voyager").service("Visrec",["cp","vl","_","consts","Config","Dataset","Logger","Fields",function(e,t,i,s,l,n,a,r){function o(i){var s=e.gen.encodings([],i,n.stats,{data:l.getData(),config:l.getConfig()}),a=e.cluster(s).map(function(e){return e.map(function(e){var s=t.Encoding.fromSpec(e,{});return{fieldSetKey:i.key,fieldSet:i,vlSpec:e,encoding:s,shorthand:s.toShorthand(),score:e.score,scoreFeatures:e.scoreFeatures}})});return a.key=i.key,a}var d={projections:[],aggregates:{},fieldSetDict:{},fieldSets:[],fieldSetKeys:[],chartClusters:{},numClustersGenerated:0,selectedCluster:null,selectedFieldSet:null,update:{}},c={genTypeCasting:!1},u={genTypeCasting:!1,maxCardinalityForAutoAddOrdinal:null,omitDotPlot:!0},g={genTypeCasting:!1};return d.update.projections=function(i){var l=(new Date).getTime(),a=e.gen.projections(i,n.stats,{}||(0===r.selected.length?u:g)),f={},h={},p=[],m={},v=(new Date).getTime();a.forEach(function(t){var i=t.key,s=i===r.selectedPKey,l=s?c:0===r.selected.length?u:g;f[i]=e.gen.aggregates([],t,n.stats,l),f[i].forEach(function(e){h[e.key]=e,e.isExactMatch=s,p.push(e)})});var w=(new Date).getTime();d.numClustersGenerated=Math.min(s.numInitClusters,p.length);for(var b=0;b<d.numClustersGenerated;b++){var y=p[b];m[y.key]=o(y)}d.projections=a,d.aggregates=f,d.fieldSetDict=h,d.fieldSets=p,d.chartClusters=m;var C=(new Date).getTime(),S=i.filter(function(e){return e.selected});console.log("gen time â€“ projections ",t.field.shorthands(S)," :",v-l,"aggregates:",w-v,"encodings:"+(C-w),"total:",C-l)},d.update.clusters=function(e){if(e>d.numClustersGenerated){var t=d.fieldSets,i=d.numClustersGenerated,s=d.chartClusters;e=Math.min(e,t.length);for(var l=i;e>l;l++){var n=t[l];s[n.key]=o(n)}d.numClustersGenerated=e}},d}]),angular.module("voyager").controller("MainCtrl",["$scope","$document","$location","Visrec","jQuery","Config","Dataset","Fields","Logger","Drop","consts","Alerts",function(e,t,i,s,l,n,a,r,o,d,c,u){function g(e,t){return e.length>t&&(e=e.substr(0,t),e=e.substr(0,Math.min(e.length,e.lastIndexOf(" "))),e+="..."),e}if(n.config.useRawDomain=!0,e.consts=c,e.canUndo=!1,e.canRedo=!1,e.Visrec=s,e.Fields=r,e.Dataset=a,e.Config=n,e.Logger=o,e.loading=!1,Object.keys(i.search()).indexOf("url")>=0){var f,h=i.search().url,p=3e4;Object.keys(i.search()).indexOf("count")>=0&&(p=i.search().count),f=Object.keys(i.search()).indexOf("job_id")>=0?i.search().job_id:Math.floor(1e4*Math.random()+1),h=h.trim(),"?"==h.substring(h.length-1)&&(h=h.substring(0,h.length-1)),h+="?&count="+p+"&first=true&format=d3",e.loading=!0,l.getJSON(h).then(function(t){if("status"in t&&"message"in t){var i=t.message,s=500;i=g(i,s),u.add("Error: "+i)}else{var l={url:h,id:f};a.update(l).then(function(){n.updateDataset(l),r.updateSchema(l.dataschema),e.loading=!1})}},function(t){e.loading=!1,u.add("Error: "+g(t.responseText,500))})}else u.add("An unknown error occurred. Please try again.")}]),angular.module("voyager").factory("Fields",["_","Dataset","vl","cp","Logger",function(e,t,i,s,l){function n(e){e.selected=void 0,e._any=!i.field.isTypes(e,["O","N"])&&"count"!==e.aggregate,delete e._raw,delete e._aggregate,delete e._timeUnit}var a={fields:{},highlighted:{},selected:[],selectedKey:null};return a.updateSchema=function(i){i=i||t.dataschema,a.fields=e(i).reduce(function(e,t){return n(t),e[t.name]=t,e},{}),a.highlighted={}},a.update=function(){var e=a.getList();return a.selected=e.filter(function(e){return e.selected}),a.selectedPKey=s.gen.projections.key(a.selected),l.logInteraction(l.actions.FIELDS_CHANGE,{selected:a.selected,list:e}),e},a.reset=function(){e.each(a.fields,n)},a.getList=function(){var i=e.sortBy(e.values(a.fields),function(e){return t.fieldOrderBy.typeThenName(e)});return i},a.setSelected=function(e,t){(a.fields[e]||{}).selected=t},a.toggleSelected=function(e){var t=a.fields[e]||{};t.selected=t.selected?void 0:!0},a.isSelected=function(e){return(a.fields[e]||{}).selected},a.setHighlight=function(e,t){a.highlighted[e]=t},t.onUpdate.push(a.updateSchema),a}]),angular.module("voyager").run(["$templateCache",function(e){e.put("app/main/main.html",'<div class="spinner" ng-show="loading"><div class="ajax_loader"><img src="assets/images/mini-loader.gif"></div></div><div class="flex-root vflex full-width full-height"><div class="full-width no-shrink"><alert-messages></alert-messages></div><div class="hflex full-width main-panel grow-1"><div class="pane data-pane noselect"><div class="card abs-100 no-top-margin"><div class="right"><dataset-selector></dataset-selector></div><h2>Columns</h2><field-list></field-list></div></div><div class="pane vis-list-pane"><vis-list></vis-list></div></div></div>'),e.put("components/alertmessages/alertmessages.html",'<div class="alert-box" ng-show="Alerts.alerts.length > 0"><div class="alert-item" ng-repeat="alert in Alerts.alerts">{{ alert.msg }} <a class="close" ng-click="Alerts.closeAlert($index)">&times;</a></div></div>'),e.put("components/fieldlist/fieldlist.html",'<div class="schema"><div class="field" ng-repeat="field in Dataset.dataschema | orderBy: Dataset.fieldOrder"><field-list-item field="field"></field-list-item></div><div class="tool"><a ng-click="Fields.reset()"><i class="fa fa-eraser"></i> Reset</a></div></div>'),e.put("components/encodingvariations/encodingvariations.html",'<div class="encoding-variations modal" ng-show="Visrec.selectedCluster"><div class="wrapper"><div class="vflex full-width full-height" id="evs" ng-if="Visrec.selectedCluster"><div class="encoding-variations-header modal-header no-shrink card no-top-margin no-right-margin margin-bottom"><div class="right"><a ng-click="close()" class="right">Close</a></div><div class="field-set-info no-bottom-margin"><b>Various Visualizations Showing</b><field-info ng-repeat="field in Visrec.selectedFieldSet" field="field" show-type="true" class="selected"></field-info><span ng-if="consts.debug" tooltips="" tooltip-size="small" tooltip-content="{{_.pluck(selectedSubcluster, \'shorthand\').join(\'<br/>\')}}"></span></div></div><div class="hflex flex-grow-1 encoding-variations-main"><div class="selected-variation no-shrink"><vl-plot-group chart="selectedSubcluster[0]" disabled="!Visrec.selectedCluster" config-set="large" show-bookmark="true" show-debug="consts.debug && consts.debugInList" show-filter-null="true" show-log="true" show-mark-type="true" show-sort="true" show-transpose="true" always-scrollable="true" tooltip="true" priority="consts.priority.popup" class="abs-100 scroll-xy full-vl-plot-group no-top-margin"></vl-plot-group></div><div class="variations vflex flex-grow-1 scroll-y" ng-if="Visrec.selectedCluster.length > 1"><div class="full-width"><vl-plot-group ng-repeat="subcluster in Visrec.selectedCluster" ng-class="{selected: selectedSubcluster == subcluster}" chart="subcluster[0]" disabled="!subcluster || !subcluster[0]" is-in-list="isInList" show-bookmark="true" rescale="true" thumbnail="true" max-width="300" ng-click="select(subcluster)" class="row-vl-plot-group clickable" priority="consts.priority.popup + $index + 1"></vl-plot-group></div></div></div></div></div></div>'),e.put("components/fieldlistitem/fieldlistitem.html",'<div class="field-list-item full-width" ng-mouseover="Fields.highlighted[field.name] = true" ng-mouseout="Fields.highlighted[field.name] = false"><i class="fa selection clickable" ng-class="{\'fa-check-square\': Fields.isSelected(field.name), \'fa-square\': Fields.isSelected(field.name) === undefined, \'fa-minus-circle\': Fields.isSelected(field.name) === false}" ng-click="Fields.toggleSelected(field.name)" ng-dblclick="consts.enableExclude && Fields.setSelected(field.name, false)"></i><field-info field="field" show-type="true" show-caret="true" disable-count-caret="true" show-info="true" popup-content="popupContent" action="Fields.toggleSelected(field.name)" class="flex-grow-1 list-item clickable" ng-class="{selected: Fields.isSelected(field.name), excluded: Fields.isSelected(field.name)===false, highlighted: Fields.highlighted[field.name]}"></field-info><div class="drop-container"><div class="popup-menu popup-functions" ng-show="(field.type!==\'O\' && field.aggregate!==\'count\') || consts.enableExclude"><div style="width:150px"><function-list field="Fields.fields[field.name]"></function-list></div><div class="inclusion" ng-show="consts.enableExclude"><h4>Field</h4><div><a ng-class="{inactive: Fields.isSelected(field.name) !== true}" ng-click="Fields.setSelected(field.name, true)"><i class="fa fa-check-square"></i> Include</a></div><div><a ng-class="{inactive: Fields.isSelected(field.name) !== undefined}" ng-click="Fields.setSelected(field.name, undefined)"><i class="fa fa-square"></i> Optional</a></div><div><a ng-class="{inactive: Fields.isSelected(field.name) !== false}" ng-click="Fields.setSelected(field.name, false)"><i class="fa fa-minus-circle"></i> Exclude</a></div></div></div></div></div>'),e.put("components/functionlist/functionlist.html",'<div class="mb5" ng-if="func.list.length > 1"><h4>Functions</h4><label class="func-label field-func" ng-repeat="f in func.list"><input type="radio" ng-value="f" ng-model="func.selected" ng-change="functionChanged(f)"> {{f === \'avg\' ? \'mean\' : f || \'-\'}}</label></div>'),e.put("components/vislist/vislist.html",'<div id="vislist" class="abs-100 scroll-y"><div class="exact-match-list" ng-if="Fields.selected.length > 0 && Visrec.aggregates[Fields.selectedPKey].length > 0"><div class="card no-top-margin vis-list-header"><span class="desc">Showing Data Variations for</span><field-info ng-repeat="(name, field) in Fields.selected" field="field" show-type="true" ng-class="{ selected: true, highlighted: (Fields.highlighted||{})[field.name] }" ng-mouseover="(Fields.highlighted||{})[field.name] = true" ng-mouseout="(Fields.highlighted||{})[field.name] = false"></field-info></div><div class="vis-list hflex flex-wrap"><vl-plot-group ng-repeat="fieldSet in Visrec.aggregates[Fields.selectedPKey]" ng-init="cluster = Visrec.chartClusters[fieldSet.key]" class="wrapped-vl-plot-group" chart="cluster[0][0]" is-in-list="isInList" field-set="fieldSet" show-bookmark="false" show-debug="consts.debug && consts.debugInList" show-expand="true" show-filter-null="true" show-sort="true" overflow="true" tooltip="true" is-selected="Fields.isSelected" highlighted="Fields.highlighted" expand-action="select(fieldSet, cluster, $index)" chart-type="bar" priority="consts.priority.vislist + $index" rendering="rendering"></vl-plot-group></div></div><div ng-if="Fields.selected.length === 0" class="card vis-list-header no-top-margin"><span class="desc">Start by looking at some univariate distributions below or select some fields with the data selector!</span></div><div ng-if="Fields.selected.length > 0" class="card vis-list-header"><span class="desc">Showing Data Variations for</span><field-info ng-repeat="(name, field) in Fields.selected" field="field" show-type="true" ng-class="{ selected: true, highlighted: (Fields.highlighted||{})[field.name] }" ng-mouseover="(Fields.highlighted||{})[field.name] = true" ng-mouseout="(Fields.highlighted||{})[field.name] = false"></field-info><span class="desc">with one additional field.</span></div><div class="vis-list hflex flex-wrap"><vl-plot-group ng-repeat="fieldSet in Visrec.fieldSets | limitTo: limit - Visrec.aggregates[Fields.selectedPKey].length" ng-init="cluster = Visrec.chartClusters[fieldSet.key]" ng-if="!fieldSet.isExactMatch" class="wrapped-vl-plot-group" chart="cluster[0][0]" is-in-list="isInList" field-set="fieldSet" is-selected="Fields.isSelected" highlighted="Fields.highlighted" show-bookmark="false" show-debug="consts.debug && consts.debugInList" show-expand="true" show-filter-null="true" show-sort="true" overflow="true" tooltip="true" chart-type="bar" expand-action="select(fieldSet, cluster, $index)" rendering="rendering"></vl-plot-group></div><encoding-variations ng-show="Visrec.selectedCluster"></encoding-variations><a ng-click="increaseLimit()"><div class="vis-list-more" ng-show="limit < Visrec.fieldSets.length">Load more...</div></a></div>')}]);