"use strict";angular.module("polestar",["ngCookies","ngSanitize","ngTouch","ngDragDrop","monospaced.elastic","zeroclipboard","ui.router","ui.select","720kb.tooltips","ngOrderObjectBy","vlui"]).constant("_",window._).constant("vl",window.vl).constant("vg",window.vg).constant("jQuery",window.$).constant("ZSchema",window.ZSchema).constant("Tether",window.Tether).constant("Drop",window.Drop).constant("Blob",window.Blob).constant("URL",window.URL).constant("dl",window.dl).constant("jsondiffpatch",window.jsondiffpatch).config(["consts",function(e){window.vl.extend(e,{appId:"polestar"})}]).config(["uiZeroclipConfigProvider",function(e){e.setZcConf({swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"})}]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl"}),t.otherwise("/404")}]),angular.module("polestar").directive("schemaListItem",["Pills",function(e){return{templateUrl:"components/schemalistitem/schemalistitem.html",restrict:"E",replace:!1,scope:{field:"="},link:function(t){t.getSchemaPill=e.getSchemaPill,t.fieldDragStart=function(){t.pill=e.getSchemaPill(t.field),e.dragStart(t.pill,null)},t.fieldDragStop=e.dragStop}}}]),angular.module("polestar").directive("shelves",function(){return{templateUrl:"components/shelves/shelves.html",restrict:"E",scope:{},replace:!0,controller:["$scope","vl","jsondiffpatch","Spec","Config","Dataset","Logger","Pills",function(e,t,n,i,r,o,a,s){e.Spec=i,e.schema=t.schema.schema,e.pills=s,e.markChange=function(){a.logInteraction(a.actions.MARK_CHANGE,i.spec.marktype)},e.chartChange=function(e){i.spec.marktype=e,a.logInteraction(a.actions.MARK_CHANGE,i.spec.marktype)},e.transpose=function(){t.Encoding.transpose(i.spec)},e.clear=function(){i.reset()},e.$watch("Spec.spec",function(e,t){a.logInteraction(a.actions.SPEC_CHANGE,e,n.diff(t,e)),i.update(e)},!0)}]}}),angular.module("polestar").directive("schemaList",["Dataset",function(e){return{templateUrl:"components/schemalist/schemalist.html",restrict:"E",scope:{},replace:!0,controller:["$scope",function(t){t.Dataset=e}]}}]),angular.module("polestar").directive("propertyEditor",function(){return{templateUrl:"components/propertyeditor/propertyeditor.html",restrict:"E",scope:{id:"=",type:"=","enum":"=",propName:"=",group:"="},link:function(){}}}),angular.module("polestar").directive("lyraExport",function(){return{template:'<a href="#" class="command" ng-click="export()">Export to lyra</a>',restrict:"E",replace:!0,scope:{},controller:["$scope","$timeout","Spec","Alerts",function(e,t,n,i){e["export"]=function(){var e=n.vgSpec;e||i.add("No vega spec present."),e.marks[0]["lyra.groupType"]="layer";var r="http://idl.cs.washington.edu/projects/lyra/app/",o=window.open(r,"_blank");t(function(){i.add("Please check whether lyra loaded the vega spec correctly. This feature is experimental and may not work.",5e3),o.postMessage({spec:e},r)},5e3)}}]}}),angular.module("polestar").directive("nullFilterDirective",["Spec",function(e){return{templateUrl:"components/nullfilterdirective/nullfilterdirective.html",restrict:"E",scope:{},link:function(t,n,i){t.Spec=e,t.updateFilter=function(){e.update()}}}}]),angular.module("polestar").directive("jsonInput",function(){return{restrict:"A",require:"ngModel",scope:{},link:function(e,t,n,i){var r=function(e){return JSON.stringify(e,null,"  ",80)};i.$formatters.push(r)}}}),angular.module("polestar").directive("functionSelect",["_","vl","Pills","Logger",function(e,t,n,i){return{templateUrl:"components/functionselect/functionselect.html",restrict:"E",scope:{encType:"=",schema:"=",field:"="},link:function(r){function o(){return n?n.pills[r.encType]:null}function a(e){var t=(r.schema||{}).properties;return t&&t.timeUnit&&(!t.timeUnit.supportedTypes||t.timeUnit.supportedTypes[e])?(t.timeUnit.supportedEnums?t.timeUnit.supportedEnums[e]:t.timeUnit["enum"])||[]:[]}function s(e){if(!e)return[d];var t=r.schema.properties;return t&&t.aggregate&&(!t.aggregate.supportedTypes||t.aggregate.supportedTypes[e])?(t.aggregate.supportedEnums?t.aggregate.supportedEnums[e]:t.aggregate["enum"])||[]:[]}var l,c="bin",p="",d="count";r.pills=n.pills,r.func={selected:p,list:[p]},r.selectChanged=function(){i.logInteraction(i.actions.FUNC_CHANGE,r.func.selected)},r.$watch("func.selected",function(i){var p=o(),d=e.clone(p),u=d?d.type:"";d&&(d.bin=i===c?{maxbins:l||t.schema.MAXBINS_DEFAULT}:void 0,d.aggregate=-1!==s(u).indexOf(i)?i:void 0,d.timeUnit=-1!==a(u).indexOf(i)?i:void 0,e.isEqual(p,d)||(n.pills[r.encType]=d,n.update(r.encType)))}),r.$watch("field",function(e){if(r.schema&&e){var n=e.name?e.type:"",i=r.schema.properties;e.bin&&(l=e.bin.maxbins);var o=-1!==["row","col","shape"].indexOf(r.encType),u="Q"===n,m="T"===n;if("*"===e.name&&e.aggregate===d)r.func.list=[d],r.func.selected=d;else{r.func.list=(o&&(u||m)?[]:[""]).concat(a(n)).concat(s(n).filter(function(e){return e!==d})).concat(i.bin&&i.bin.supportedTypes[n]?["bin"]:[]);var g=o&&u&&c||m&&t.schema.defaultTimeFn||p,f=e.bin?"bin":e.aggregate||e.timeUnit||g;r.func.selected=r.func.list.indexOf(f)>=0?f:g}}},!0)}}}]),angular.module("polestar").directive("configurationEditor",function(){return{templateUrl:"components/configurationeditor/configurationeditor.html",restrict:"E",scope:{},controller:["$scope","Config",function(e,t){e.Config=t}]}}),angular.module("polestar").directive("fieldDefEditor",["Dataset","Pills","_","Drop","Logger",function(e,t,n,i,r){return{templateUrl:"components/fielddefeditor/fielddefeditor.html",restrict:"E",replace:!0,scope:{encType:"=",enc:"=",schema:"=fieldDefSchema",marktype:"="},link:function(o,a){function s(){return t.pills[o.encType]}var l,c;o.allowedCasting={Q:["Q","O","N"],O:["O","N"],N:["N","O"],T:["T","O","N"],G:["G","O","N"]},o.Dataset=e,o.typeNames=e.typeNames,o.pills=t.pills,l=new i({content:a.find(".shelf-properties")[0],target:a.find(".shelf-label")[0],position:"bottom left",openOn:"click"}),o.fieldInfoPopupContent=a.find(".shelf-functions")[0],o.removeField=function(){t.remove(o.encType)},o.fieldDragStart=function(){t.dragStart(t[o.encType],o.encType)},o.fieldDragStop=function(){t.dragStop()},o.fieldDropped=function(){var e=s();c&&(c=null);var i=o.schema.properties.type["enum"];n.contains(i,e.type)||(e.type=i[0]),t.dragDrop(o.encType),r.logInteraction(r.actions.FIELD_DROP,o.enc[o.encType])},o.$watch("enc[encType]",function(e){t.pills[o.encType]=e?n.cloneDeep(e):{}},!0),o.$watchGroup(["allowedCasting[Dataset.dataschema.byName[enc[encType].name].type]","enc[encType].aggregate"],function(e){var t=e[0],n=e[1];o.allowedTypes="count"===n?["Q"]:t})}}}]),angular.module("polestar").directive("alertMessages",["Alerts",function(e){return{templateUrl:"components/alertmessages/alertmessages.html",restrict:"E",scope:{},link:function(t){t.Alerts=e}}}]),angular.module("polestar").service("Pills",["vl","Spec","_","$window",function(e,t,n,i){function r(t){return e.schema.util.instantiate(a[t])}function o(t,n,o){var s=n.type,l=e.schema.getSupportedRole(o),c=l.dimension&&!l.measure;n.name&&c?"count"===n.aggregate?(n={},i.alert("COUNT not supported here!")):"Q"!==s||n.bin?"T"!==s||n.timeUnit||(n.timeUnit=e.schema.defaultTimeFn):(n.aggregate=void 0,n.bin={maxbins:e.schema.MAXBINS_DEFAULT}):n.name||(n={});var p=r(o),d=a[o].properties;for(var u in d)n[u]&&("value"===u&&n.name?delete p[u]:p[u]=n[u]);t[o]=p}var a=e.schema.schema.properties.encoding.properties,s={pills:{}};return s.getSchemaPill=function(e){return{name:e.name,type:e.type,aggregate:e.aggregate}},s.remove=function(e){delete s.pills[e],o(t.spec.encoding,{},e)},s.update=function(e){o(t.spec.encoding,s.pills[e],e)},s.dragStart=function(e,t){s.pills.dragging=e,s.pills.etDragFrom=t},s.dragStop=function(){delete s.pills.dragging},s.dragDrop=function(e){var i=n.clone(t.spec.encoding),r=s.pills.etDragFrom;r&&o(i,s.pills[r]||{},r),o(i,s.pills[e]||{},e),t.spec.encoding=i,r=null},s}]),angular.module("polestar").service("Spec",["_","vl","ZSchema","Alerts","Config","Dataset",function(e,t,n,i,r,o){function a(n){for(var i in n)e.isObject(n[i])&&a(n[i]),(null===n[i]||void 0===n[i]||e.isObject(n[i])&&0===t.keys(n[i]).length||n[i]===[])&&delete n[i]}var s={spec:null,chart:{vlSpec:null,encoding:null,shorthand:null,vgSpec:null}};return s._removeEmptyFieldDefs=function(n){n.encoding=e.omit(n.encoding,function(e,i){return!e||void 0===e.name&&void 0===e.value||n.marktype&&!t.schema.schema.properties.encoding.properties[i].supportedMarktypes[n.marktype]})},s.parseShorthand=function(e){var n=t.Encoding.parseShorthand(e,r.config).toSpec();s.parseSpec(n)},s.parseSpec=function(e){s.spec=t.schema.util.merge(s.instantiate(),e)},s.instantiate=function(){var e=t.schema.instantiate();return e.marktype=t.schema.schema.properties.marktype["enum"][0],e.config=r.config,e.data=r.data,e},s.reset=function(){s.spec=s.instantiate()},s.update=function(o){o=e.cloneDeep(o||s.spec),s._removeEmptyFieldDefs(o),a(o),"encoding"in o||(o.encoding={});var l=new n;l.setRemoteReference("http://json-schema.org/draft-04/schema",{});var c=t.schema.schema,p=l.validate(o,c);if(p){t.extend(o.config,r.large());var d=t.Encoding.fromSpec(o),u=s.chart;u.fieldSet=s.spec.encoding,u.vlSpec=o,u.cleanSpec=d.toSpec(!1),u.shorthand=d.toShorthand(),console.log("chart",u.vgSpec,u.vlSpec)}else i.add({msg:l.getLastErrors()})},s.reset(),o.onUpdate.push(s.reset),s}]),angular.module("polestar").controller("MainCtrl",["$scope","$document","$location","Spec","jQuery","Dataset","Config","consts","Logger","Alerts",function(e,t,n,i,r,o,a,s,l,c){function p(e,t){return e.length>t&&(e=e.substr(0,t),e=e.substr(0,Math.min(e.length,e.lastIndexOf(" "))),e+="..."),e}if(e.Spec=i,e.Dataset=o,e.Config=a,e.Logger=l,e.consts=s,e.showDevPanel=!1,e.canUndo=!1,e.canRedo=!1,e.loading=!1,e.rendering=!1,console.log(n.search()),Object.keys(n.search()).indexOf("url")>=0){var d,u=n.search().url,m=3e4;Object.keys(n.search()).indexOf("count")>=0&&(m=n.search().count),d=Object.keys(n.search()).indexOf("job_id")>=0?n.search().job_id:Math.floor(1e4*Math.random()+1),u=u.trim(),"?"==u.substring(u.length-1)&&(u=u.substring(0,u.length-1)),u+="?&count="+m+"&first=true&format=d3",e.loading=!0,r.getJSON(u).then(function(t){if("status"in t&&"message"in t){var n=t.message,i=500;n=p(n,i),c.add("Error: "+n)}else{var r={url:u,id:d};o.update(r).then(function(){a.updateDataset(r),e.loading=!1})}},function(t){e.loading=!1,c.add("Error: "+p(t.responseText,500))})}else c.add("An unknown error occurred. Please try again.")}]),angular.module("polestar").run(["$templateCache",function(e){e.put("app/main/main.html",'<div class="spinner" ng-show="loading"><div class="ajax_loader"><img src="assets/images/mini-loader.gif"></div></div><div class="vflex full-width full-height"><div class="full-width no-shrink"><alert-messages></alert-messages></div><div class="hflex full-width full-height"><div class="pane data-pane noselect flex-root"><div class="card abs-100"><h2>Columns</h2><schema-list></schema-list></div></div><div class="vflex full-width full-height main-panel grow-1"><div class="pane encoding-pane" style="width: 100%;padding: 0px;margin: 0px;"><shelves></shelves></div><div class="pane vis-pane"><div class="spinner" ng-show="rendering"><div class="ajax_loader"><img src="assets/images/mini-loader.gif"></div></div><vl-plot-group class="abs-100 no-right-margin full-vl-plot-group" chart="Spec.chart" show-bookmark="true" show-filter-null="true" show-log="true" show-mark-type="true" show-sort="true" show-transpose="true" config-set="large" chart-type="Spec.spec.marktype" show-label="true" tooltip="true" always-scrollable="true" rendering="rendering"></vl-plot-group></div></div></div></div>'),e.put("components/alertmessages/alertmessages.html",'<div class="alert-box" ng-show="Alerts.alerts.length > 0"><div class="alert-item" ng-repeat="alert in Alerts.alerts">{{ alert.msg }} <a class="close" ng-click="Alerts.closeAlert($index)">&times;</a></div></div>'),e.put("components/configurationeditor/configurationeditor.html","<form><pre>{{ Config.config | compactJSON }}</pre></form>"),e.put("components/fielddefeditor/fielddefeditor.html",'<div class="shelf-group"><div class="shelf" ng-class="{disabled: !schema.supportedMarktypes[marktype]}"><div class="shelf-label" ng-class="{expanded: propsExpanded}"><i class="fa fa-caret-down"></i> {{ encType }}</div><div class="field-drop" ng-model="pills[encType]" data-drop="schema.supportedMarktypes[marktype]" jqyoui-droppable="{onDrop:\'fieldDropped\'}" data-jqyoui-options="{activeClass: \'drop-active\'}"><field-info ng-show="enc[encType].name" ng-class="{expanded: funcsExpanded}" field="enc[encType]" show-type="true" show-caret="true" disable-count-caret="true" popup-content="fieldInfoPopupContent" show-remove="true" remove-action="removeField()" class="selected draggable full-width" data-drag="true" ng-model="pills[encType]" jqyoui-draggable="{onStart: \'fieldDragStart\', onStop:\'fieldDragStop\'}" data-jqyoui-options="{revert: \'invalid\', helper: \'clone\'}"></field-info><span class="placeholder" ng-if="!enc[encType].name">drop a column here</span></div></div><div class="drop-container"><div class="popup-menu shelf-properties shelf-properties-{{encType}}"><div><property-editor ng-show="schema.properties.legend" id="encType + \'legend\'" type="schema.properties.legend.type" enum="schema.properties.legend.enum" prop-name="\'legend\'" group="enc[encType]"></property-editor></div><div><property-editor ng-show="schema.properties.value" id="encType + \'value\'" type="schema.properties.value.type" enum="schema.properties.value.enum" prop-name="\'value\'" group="enc[encType]"></property-editor></div><div ng-repeat="group in [\'scale\', \'text\', \'axis\', \'bin\']" ng-show="schema.properties[group]"><h4>{{ group }}</h4><div ng-repeat="(propName, scaleProp) in schema.properties[group].properties" ng-init="id = encType + group + $index" ng-show="scaleProp.supportedTypes ? scaleProp.supportedTypes[enc[encType].type] : true"><property-editor id="id" type="scaleProp.type" enum="scaleProp.enum" prop-name="propName" group="enc[encType][group]"></property-editor></div></div></div><div class="popup-menu shelf-functions shelf-functions-{{encType}}"><div class="mb5"><h4>Types</h4><span ng-if="allowedTypes.length<=1">{{typeNames[enc[encType].type]}}</span> <label class="type-label" ng-if="allowedTypes.length>1" ng-repeat="type in allowedTypes"><input type="radio" ng-value="type" ng-model="enc[encType].type"> {{typeNames[type]}}</label></div><function-select field="enc[encType]" enc-type="encType" schema="schema"></function-select></div></div></div>'),e.put("components/functionselect/functionselect.html",'<div class="mb5" ng-if="func.list.length > 1 || func.list[0] !== \'\'"><h4>Functions</h4><label class="func-label field-func" ng-repeat="f in func.list"><input type="radio" ng-value="f" ng-model="func.selected" ng-change="selectChanged()"> {{f === \'avg\' ? \'mean\' : f || \'-\'}}</label></div>'),e.put("components/nullfilterdirective/nullfilterdirective.html",'<label><input ng-model="Spec.spec.config.filterNull.O" ng-change="updateFilter()" type="checkbox"> Remove null values</label>'),e.put("components/propertyeditor/propertyeditor.html",'<label class="prop-label" for="{{ id }}">{{ propName }}</label><div class="inline-block" ng-switch="type + (enum !== undefined ? \'list\' : \'\')"><input id="{{ id }}" ng-switch-when="boolean" type="checkbox" ng-model="group[propName]"><select id="{{ id }}" ng-switch-when="stringlist" ng-model="group[propName]" ng-options="choice for choice in enum track by choice"></select><input id="{{ id }}" type="number" ng-switch-when="integer" ng-model="group[propName]" ng-model-options="{debounce: 200}"> <input id="{{ id }}" type="string" ng-switch-when="string" ng-model="group[propName]" ng-model-options="{debounce: 500}"></div>'),e.put("components/schemalist/schemalist.html",'<div class="schema full-width"><schema-list-item field="field" ng-repeat="field in Dataset.dataschema | orderBy : Dataset.fieldOrder"></schema-list-item></div>'),e.put("components/schemalistitem/schemalistitem.html",'<field-info field="field" show-type="true" show-info="true" class="pill list-item draggable full-width no-right-margin" ng-model="pill" data-drag="true" jqyoui-draggable="{placeholder: \'keep\', deepCopy: true, onStart: \'fieldDragStart\', onStop:\'fieldDragStop\'}" data-jqyoui-options="{revert: \'invalid\', helper: \'clone\', scroll: \'false\', appendTo:\'body\'}"></field-info>'),e.put("components/shelves/shelves.html",'<div class="card scroll-y"><div class="shelf-pane shelf-encoding-pane full-width"><h2>Positional</h2><field-def-editor enc-type="\'x\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.x"></field-def-editor><field-def-editor enc-type="\'y\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.y"></field-def-editor><field-def-editor enc-type="\'col\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.col"></field-def-editor><field-def-editor enc-type="\'row\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.row"></field-def-editor></div><div class="shelf-pane shelf-marks-pane full-width"><a class="right" ng-click="clear()"><i class="fa fa-trash-o"></i> Clear</a><h2>Marks</h2><field-def-editor enc-type="\'size\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.size"></field-def-editor><field-def-editor enc-type="\'color\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.color"></field-def-editor><field-def-editor enc-type="\'shape\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.shape"></field-def-editor><field-def-editor enc-type="\'detail\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.detail"></field-def-editor><field-def-editor enc-type="\'text\'" enc="Spec.spec.encoding" marktype="Spec.spec.marktype" field-def-schema="schema.properties.encoding.properties.text"></field-def-editor></div></div>')}]);